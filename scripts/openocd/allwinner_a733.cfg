# SPDX-License-Identifier: GPL-2.0-or-later
# This is the config for an Allwinner A733/T736 (sun60iw2).

adapter speed 4000

reset_config none srst_pulls_trst

if { [info exists CHIPNAME] } {
	set _CHIPNAME $CHIPNAME
} else {
	set _CHIPNAME a733
}

if { [info exists DAP_TAPID] } {
	set _DAP_TAPID_BCORE $DAP_TAPID
} else {
	set _DAP_TAPID_BCORE 0x5ba00477
}

set _DAP_TAPID_LCORE 0x2ba06477

if { [info exists CHIPCORES] } {
	set _cores $CHIPCORES
} else {
	set _cores 8
}

if { [info exists USE_SMP] } {
	set _USE_SMP $USE_SMP
} else {
	set _USE_SMP 0
}

set _AP_ARMV8_APB	0x00001000
set _AP_ARMV8_AHB	0x00002000

transport select jtag

# declare the JTAG taps to access the DAPs (big core and little core)
jtag newtap $_CHIPNAME tap0 -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_DAP_TAPID_BCORE -ignore-version
jtag newtap $_CHIPNAME tap1 -irlen 4 -ircapture 0x1 -irmask 0xf -expected-id $_DAP_TAPID_LCORE -ignore-version

# create two DAP instances - one for each core cluster
dap create $_CHIPNAME.dap0 -chain-position $_CHIPNAME.tap0 -adiv6
dap create $_CHIPNAME.dap1 -chain-position $_CHIPNAME.tap1 -adiv6
# create AP interfaces for each DAP
# Big core cluster DAP interfaces
target create $_CHIPNAME.apb0 mem_ap -endian little -dap $_CHIPNAME.dap0 -ap-num $_AP_ARMV8_APB
target create $_CHIPNAME.ahb0 mem_ap -endian little -dap $_CHIPNAME.dap0 -ap-num $_AP_ARMV8_AHB

# Little core cluster DAP interfaces
target create $_CHIPNAME.apb1 mem_ap -endian little -dap $_CHIPNAME.dap1 -ap-num $_AP_ARMV8_APB
target create $_CHIPNAME.ahb1 mem_ap -endian little -dap $_CHIPNAME.dap1 -ap-num $_AP_ARMV8_AHB

# declare the main application cores
set _smp_command ""

# LITTLE Core
set _TARGETNAME $_CHIPNAME.lcore

set $_TARGETNAME.base(0) 0x09010000
set $_TARGETNAME.base(1) 0x09110000
set $_TARGETNAME.base(2) 0x09210000
set $_TARGETNAME.base(3) 0x09310000
set $_TARGETNAME.base(4) 0x09410000
set $_TARGETNAME.base(5) 0x09510000

set $_TARGETNAME.cti(0) 0x09020000
set $_TARGETNAME.cti(1) 0x09120000
set $_TARGETNAME.cti(2) 0x09220000
set $_TARGETNAME.cti(3) 0x09320000
set $_TARGETNAME.cti(4) 0x09420000
set $_TARGETNAME.cti(5) 0x09520000

# big Core
set _TARGETNAME $_CHIPNAME.bcore

set $_TARGETNAME.base(6) 0x09610000
set $_TARGETNAME.base(7) 0x09710000

set $_TARGETNAME.cti(6) 0x09620000
set $_TARGETNAME.cti(7) 0x09720000

for { set _core 0 } { $_core < $_cores } { incr _core 1 } {
    if {$_core < 6} {
        set _TARGETNAME $_CHIPNAME.lcore
        set _dap_name $_CHIPNAME.dap1
        set _ap_num $_AP_ARMV8_APB
    } else {
        set _TARGETNAME $_CHIPNAME.bcore
        set _dap_name $_CHIPNAME.dap0
        set _ap_num $_AP_ARMV8_APB
    }

	cti create cti$_core -dap $_dap_name -baseaddr [set $_TARGETNAME.cti($_core)] -ap-num $_ap_num

	target create ${_TARGETNAME}$_core aarch64 -endian little \
				 -dap $_dap_name -coreid $_core -cti cti$_core \
				 -dbgbase [set $_TARGETNAME.base($_core)] -ap-num $_ap_num

	if { $_core != 0 } {
		${_TARGETNAME}$_core configure -defer-examine
	}
	set _smp_command "$_smp_command ${_TARGETNAME}$_core"
}

if {$_USE_SMP} {
	eval $_smp_command
}

# default target is cpu0
targets $_CHIPNAME.lcore0
